<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²</title>
</head>
<body>
  <h1>ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²</h1>
  <input type="text" id="username" placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›" />
  <button id="registerBtn">ç™»éŒ²</button>

  <script>
    const registerBtn = document.getElementById('registerBtn');

    registerBtn.addEventListener('click', async () => {
      const username = document.getElementById('username').value;
      if (!username) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      try {
        // ã‚¹ãƒ†ãƒƒãƒ—1: ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ç™»éŒ²ãƒãƒ£ãƒ¬ãƒ³ã‚¸ã‚’å–å¾—
        const rawOptions = await fetch('/webauthn/register/begin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        }).then(r => r.json());
        console.log(rawOptions); 
        const publicKey = PublicKeyCredential.parseCreationOptionsFromJSON(rawOptions.publicKey);
        const credential = await navigator.credentials.create({ publicKey });

        console.log(credential.toJSON())
        const credJSON = credential.toJSON()
        
        // ã‚¹ãƒ†ãƒƒãƒ—3: èªè¨¼æƒ…å ±ã‚’ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡ã—ã¦ç™»éŒ²å®Œäº†
        const result = await fetch('/webauthn/register/finish', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(credJSON),
          // body: JSON.stringify({
          //   credential: credJSON, // ğŸ‘ˆ ãƒ©ãƒƒãƒ—ã™ã‚‹
          // }),
          // body: JSON.stringify({
          //   username: username,
          //   id: credential.id,
          //   rawId: btoa(String.fromCharCode(...new Uint8Array(credential.rawId))),
          //   type: credential.type,
          //   response: {
          //     attestationObject: btoa(String.fromCharCode(...new Uint8Array(credential.response.attestationObject))),
          //     clientDataJSON: btoa(String.fromCharCode(...new Uint8Array(credential.response.clientDataJSON))),
          //   }
          // })
        });

        if (result.ok) {
          alert('ãƒ‘ã‚¹ã‚­ãƒ¼ç™»éŒ²æˆåŠŸï¼');
        } else {
          alert('ç™»éŒ²å¤±æ•—');
        }

      } catch (err) {
        console.error(err);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    });
  </script>
</body>
</html>
